# AGENTS.md

## Project: **PR¬†Nudge** ‚Äì Daily Slack digest of stale pull‚Äërequests
A lightweight Python service that fetches open pull‚Äërequests from GitHub (or GitLab), filters ones with **no commits or comments in the last _N_ days** (default‚ÄØ=‚ÄØ3), formats a short Markdown digest, and posts it to a Slack channel via an **Incoming‚ÄØWebhook**.

---

### 1. Suggested Repository Layout

| Path | Purpose |
|------|---------|
| `pr_nudge.py` | Main entry‚Äëpoint. Contains: `fetch_prs()`, `filter_stale()`, `build_message()`, `post_to_slack()`, and a thin `main()` wrapper. |
| `config.py` | Reads env‚Äëvars, provides defaults, and validates required settings. |
| `tests/` | All unit tests (pytest). |
| `tests/test_pr_nudge.py` | Mocks GitHub & Slack HTTP calls; asserts core behaviours. |
| `requirements.txt` | Runtime deps (`requests`, `python‚Äëdotenv`, `pytest`, `responses`, `ruff`, `black`). |
| `Dockerfile` *(optional)* | Containerised run‚Äêtime (python:slim). |

---

### 2. Quick‚Äëstart (local)

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
export GITHUB_TOKEN=ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXX
export SLACK_WEBHOOK=https://hooks.slack.com/services/XXX/YYY/ZZZ
export ORG=my‚Äëorg           # or set REPO=my‚Äëorg/my‚Äërepo
export STALE_DAYS=3         # optional; default = 3
python pr_nudge.py
```

**Tip:** Only *one* of `ORG` or `REPO` is required.  
If `ORG` is provided, the script targets **all** repositories underneath that organisation.

---

### 3. Environment Variables

| Name | Required | Example | Notes |
|------|----------|---------|-------|
| `GITHUB_TOKEN` | ‚úÖ | `ghp_abcd‚Ä¶` | Needs `repo:read` scope. |
| `SLACK_WEBHOOK` | ‚úÖ | `https://hooks.slack.com/services/T/B/KEY` | Channel is configured on Slack side. |
| `ORG` | ‚¨ú | `openai` | Query every repo in an org. |
| `REPO` | ‚¨ú | `openai/gym` | Target a single repo. |
| `STALE_DAYS` | ‚¨ú | `5` | Integer¬†‚â•¬†1. Default‚ÄØ=‚ÄØ3. |

---

### 4. Testing & Quality Gates

* **Run all tests**

  ```bash
  pytest -q
  ```

* **Static analysis / formatting**

  ```bash
  ruff .        # lints
  black --check .  # formatting
  ```

CI (GitHub Actions) **fails** if either command returns a non‚Äëzero exit code.

---

### 5. How to Extend

1. **Label filtering** ‚Äì Add `LABEL_EXCLUDE="WIP,experimental"` to skip PRs with these labels.  
2. **Cron / Scheduler** ‚Äì Deploy via GitHub Actions (`workflow_dispatch` + `schedule`) or a platform‚Äëcron.  
3. **Slash‚Äëcommand** ‚Äì Wrap `build_message()` in a small Flask app and expose `/stale‚Äëprs`.  

---

### 6. Internals Cheat‚ÄëSheet

| Function | I/O | Notes |
|----------|-----|-------|
| `fetch_prs(session, *, org=None, repo=None)` | ‚Üí `list[dict]` | Calls GitHub REST, paginated, returns raw PR JSON. |
| `filter_stale(prs, stale_days)` | ‚Üí `list[dict]` | Uses `updated_at` + `comments` + `commits` timestamps. |
| `build_message(stale_prs)` | ‚Üí `str` | Returns Markdown block ready for Slack. |
| `post_to_slack(message, webhook_url)` | ‚Üí `None` | HTTP POST; raises on non‚Äë2xx. |

Each helper is **pure / deterministic** except for I/O; this enables fast unit testing.

---

### 7. Conventions & Style Guide

* **Python¬†‚â•‚ÄØ3.12**
* Use **type hints** everywhere (`mypy` friendly).
* External HTTP interactions go through a **single `requests.Session`** instance to ease mocking.
* Avoid global state; config is passed explicitly or read once in `main()`.
* Keep the script under **150 LOC** (excluding tests).

---

### 8. How Codex Agents Should Work Here

1. **Install deps & run tests** (`pytest`, `ruff`, `black --check`).
2. Make edits on a new branch; run tests + lint locally.
3. Commit, push, open a PR. Use the PR template auto‚Äëgenerated by GitHub (`.github/PULL_REQUEST_TEMPLATE.md`).
4. Ensure all CI checks pass before merging.

---

Happy hacking! üéâ
